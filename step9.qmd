# Step 3

## hdPS: General Idea

Assess recurrence to create proxy variables (empirical covariates / .red\[EC\]):

| ICD-10-CM code (dimension 1)  | code appeared at least once | code appeared at least more than the median | code appeared at least more than the 75th percentile |
|------------------|------------------|------------------|------------------|
| **D64.9** Anemia              | dx_D64_once                 | dx_D64_sporadic                             | dx_D64_frequent                                      |
| **D75.9P** Blood clots        | dx_D75_once                 | dx_D75_sporadic                             | dx_D75_frequent                                      |
| **D89.9** Immune disorder     | dx_D89_once                 | dx_D89_sporadic                             | dx_D89_frequent                                      |
| $\ldots$                      | $\ldots$                    | $\ldots$                                    | $\ldots$                                             |
| **E07.9** Disorder of thyroid | dx_E07_once                 | dx_E07_sporadic                             | dx_E07_frequent                                      |

-   Granularity considered = **3 digit**
-   Number of dimensions (**126**) $\times$
    -   **3** intensity $\times$
    -   most prevalent codes (usually **200**; although this is [disputed](https://doi.org/10.1002/pds.3773))
    -   = Many .red\[EC\]s

A large number of binary covariates

```{r echo=FALSE, out.width='1000%', fig.align="center"}
knitr::include_graphics('images/bincodes.png')
```

## hdPS mechanism: find useful ECs

```{r echo=FALSE, out.width='95%', fig.align="left"}
knitr::include_graphics('images/eq1.png')
```

In our example, we use the following in the [Bross (1966)](https://pubmed.ncbi.nlm.nih.gov/5966011/) formula: $$
\begin{aligned}
U &=& \text{Overall health status}
\end{aligned}
$$

```{r echo=FALSE, out.width='100%', fig.align="left"}
knitr::include_graphics('images/eq2.png')
```

In our example, we use the following in the [Bross (1966)](https://pubmed.ncbi.nlm.nih.gov/5966011/) formula to prioritize covariates: $$
\begin{aligned}
EC &=& \text{dx_D64_once} \\
&=& \text{dx_D75_sporadic} \\
&&  \ldots\\
&=& \text{dx_E07_frequent}
\end{aligned}
$$

$$
\text{bias_M} = \frac{P_{C1} \times (\text{RR}_{CD} - 1) + 1}{P_{C0} \times (\text{RR}_{CD} - 1) + 1}
$$

::: callout-tip
## Steps

-   We use the same 4 steps for the propensity score weighting analysis when the exposure is multi-category.
-   exposure modelling needs to be handled by generalized linear models that can accommodate multi-categories of exposure.
:::

::: callout-tip
Stopping rules specified earlier has 2 components:

-   a balance metric (for covariates) and
-   rule for summarizing (across covariates).
:::

# Step 2

Rank (descending) each EC by the magnitude of log-bias: Absolute log $Bias_M$

| Rank by bias | Absolute log $Bias_M$ | EC              |
|--------------|-----------------------|-----------------|
| 1            | 0.42                  | dx_E07_frequent |
| 2            | 0.32                  | dx_D89_sporadic |
| 3            | 0.25                  | dx_E07_once     |
| $\ldots$     | $\ldots$              | $\ldots$        |
| n            | 0.01                  | dx_D64_once     |

Take top 100 of these .red\[EC\]s. These are hdPS variables.

```{r echo=FALSE, out.width='100%', fig.align="center"}
knitr::include_graphics('images/psmodelhd.png')
```

::: callout-tip
## Steps

-   We use the same 4 steps for the propensity score weighting analysis when the exposure is continuous.
-   exposure modelling needs to be handled by generalized linear models that can accommodate continuous scale exposure.
:::

::: callout-tip
Based on absolute Pearson **correlation** between the exposure and each confounder
:::
# Extensions to hdPS

## hdPS: Ways to improve

-   .red\[EC\]s selected separately / univariately
    -   can be **correlated** (coming from same patient),
        -   could provide same information
        -   **may not be useful anymore** in the presence of others
    -   may inflate **variance**
        -   General overfitting problem
-   **Multivariate structure** is good to consider in a single model

## Variable selection in PS context

.pull-left\[ - [Brookhart et al. (2006)](https://doi.org/10.1093/aje/kwj149) AJE

-   [Myers et al. (2011)](https://doi.org/10.1093/aje/kwr364) AJE

-   [Pearl (2011)](https://doi.org/10.1093/aje/kwr352) AJE

-   [Schuster et al (2016)](https://doi.org/10.1016/j.jclinepi.2016.05.017) JCE \]

.pull-right\[ - bias amplification

-   inflated variance

-   overfitting \]

```{r echo=FALSE, out.width='65%', fig.align="center"}
knitr::include_graphics('images/vartype.png')
```

## Variable selection in PS context

```{r echo=FALSE, out.width='90%', fig.align="center"}
knitr::include_graphics('images/vartype2.png')
```

-   Same idea for the proxies.
-   Pre-exposure measurements.
-   Jointly consider all proxies **in one model** to perform variable selection
